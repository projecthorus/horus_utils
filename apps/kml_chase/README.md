# KML Payload Data Server

This folder contains code to display payload (and chase car!) position data in Google Earth, or anything else that can handle 'live' KML data.

For this to run, you will need the horuslib library installed. Refer to the [Installation guide](https://github.com/projecthorus/horus_utils/wiki/1.-Dependencies-&-Installation).

This is very much a work-in-progress, with much to be completed. For now, the following works:

To listen for payload data from OziMux (i.e. on UDP:localhost:8942):
```
$ python kml_server.py --ozimux
```

To listen for payload data via the UDP broadcast 'Payload Summary' messages (which can be generated by OziMux, but also by [radiosonde_auto_rx](https://github.com/projecthorus/radiosonde_auto_rx/)):
```
$ python kml_server.py --summary
```

Once running, load the `payload_position.kml` file in Google Earth, and it should start auto-updating.

Other command-line options include:
```
  --clamp               Clamp all tracks to ground.
  --nolabels            Inhibit labels on placemarks.
```

The server can be stopped with CTRL+C.

## Live Predictions
kml_server can also run live predictions of the flight path. 

To do this you need cusf_predictor_wrapper and it's dependencies installed. Refer to the [documentation on how to install this](https://github.com/darksidelemm/cusf_predictor_wrapper/).
Once compiled and installed, you will need to: 
 * Copy the 'pred' binary into this directory. If using the Windows build, this will be `pred.exe`; under Linux/OSX, just `pred`.
 * [Download wind data](https://github.com/darksidelemm/cusf_predictor_wrapper/#3-getting-wind-data) for your area of interest, and place the .dat files into the gfs subdirectory. 

The following additional arguments can then be used:

```
  --predict             Enable Flight Path Predictions.
  --predict_binary PREDICT_BINARY
                        Location of the CUSF predictor binary. Defaut = ./pred
  --burst_alt BURST_ALT
                        Expected Burst Altitude (m). Default = 30000
  --descent_rate DESCENT_RATE
                        Expected Descent Rate (m/s, positive value). Default =
                        5.0
  --abort               Enable 'Abort' Predictions.
  --predict_rate PREDICT_RATE
                        Run predictions every X seconds. Default = 15 seconds.
```

For example, to use kml_server to observe a typical radiosonde launch (using data emitted via the [payload summary messages](https://github.com/projecthorus/radiosonde_auto_rx/wiki/Configuration-Settings#payload-summary-output)), you would run:
```
$ python kml_server.py --summary --predict --burst_alt=26000 --descent_rate=7.0
```


A few notes:
 * The ascent rate is calculated automatically, and is an average of the last 6 positions.
 * The 'Abort' prediction option is used to display a second prediction, which displays what would occur if the balloon burst *now*. This is useful for flights where you have a cutdown payload available, and want to know when to trigger it! This prediction disappears when the payload is either above the expected burst altitude, or is descending.
